name: Build Jailbreak Repo

on:
  push:
    branches: [ main ]
    paths:
      - 'debs/**'
      - '.github/workflows/build.yml'
      - 'index_template.html'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dpkg-dev
        run: |
          sudo apt update
          sudo apt install -y dpkg-dev gzip

      - name: Ensure debs folder exists
        run: mkdir -p debs

      - name: Generate Packages
        run: |
          dpkg-scanpackages ./debs /dev/null > Packages
          gzip -k -f Packages

      - name: Generate Release
        run: |
          printf "Origin: LDPPKONG Repo\n" > Release
          printf "Label: LDPPKONG Repo\n" >> Release
          printf "Suite: stable\n" >> Release
          printf "Version: 1.0\n" >> Release
          printf "Codename: ios\n" >> Release
          printf "Architectures: iphoneos-arm64\n" >> Release
          printf "Components: main\n" >> Release
          printf "Description: LDPPKONG Jailbreak Repo\n" >> Release

      - name: Generate index.html from template
        run: |
          cp index_template.html index.html
          sed -i 's|\${repo_url}|https://ldppkong.github.io/jailbreak-repo/|g' index.html

      - name: Commit and Push All
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Packages Packages.gz Release index.html
          git diff --cached --quiet && echo "No changes to commit." || git commit -m "Update Packages and index.html"
          git push
